/*! grafana - v2.1.3 - 2015-08-24
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache License */

define(["angular","lodash","jquery"],function(a,b,c){"use strict";a.module("grafana.directives").directive("influxdbFuncEditor",["$compile",function(a){var d='<a gf-dropdown="functionMenu" class="dropdown-toggle" data-toggle="dropdown">{{field.func}}</a><span>(</span>',e='<input type="text" style="display:none" class="input-mini tight-form-func-param"></input>',f=["count","mean","sum","min","max","mode","distinct","median","derivative","non_negative_derivative","stddev","first","last","difference"],g=b.map(f,function(a){return{text:a,click:"changeFunction('"+a+"');"}});return{restrict:"A",scope:{field:"=",getFields:"&",onChange:"&"},link:function(b,f){function h(){var a=c(this),d=a.next();d.val(b.field.name),d.css("width",a.width()+16+"px"),a.hide(),d.show(),d.focus(),d.select();var e=d.data("typeahead");e&&(d.val(""),e.lookup())}function i(){var a=c(this),d=a.prev();""!==a.val()&&(d.text(a.val()),b.field.name=a.val(),b.$apply(b.onChange())),a.hide(),d.show()}function j(a){13===a.which&&i.call(this)}function k(){this.style.width=8*(3+this.value.length)+"px"}function l(a){a.attr("data-provide","typeahead"),a.typeahead({source:function(a,c){return b.getFields().then(function(a){c(a)})},minLength:0,items:20,updater:function(b){return setTimeout(function(){i.call(a[0])},0),b}});var d=a.data("typeahead");d.lookup=function(){var a;return this.query=this.$element.val()||"",a=this.source(this.query,c.proxy(this.process,this)),a?this.process(a):a}}function m(){n.appendTo(f);var d=c('<a ng-click="" class="graphite-func-param-link">'+b.field.name+"</a>"),g=c(e);d.appendTo(f),g.appendTo(f),g.blur(i),g.keyup(k),g.keypress(j),d.click(h),l(g),c("<span>)</span>").appendTo(f),a(f.contents())(b)}var n=c(d);b.functionMenu=g,b.changeFunction=function(a){b.field.func=a,b.onChange()},m()}}}])});